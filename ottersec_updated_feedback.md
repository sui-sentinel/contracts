# Feedback date: Dec 24, 2025

Hey, we’ve reviewed the patch and here’s our feedback. We also list the remaining unresolved items and would love to get your thoughts

Issues

1. In consume_prompt, the relationship between the Agent and the Enclave is not verified, so an attacker could use a signature generated by a fake Enclave to win
   => when an enclave is updated, if multiple enclaves exist, it is not defined which enclave will be used for execution

   - Fixed, Now enclave id is set in protocol config and only authorized enclave can be used in the contract.

2. Since multiple enclave's config can be created by a module, its possible to create an enclave using one, and then use a different config to destroy it (if the later has a bigger version).
   => not fixed
   
   - Fixed, now every enclave have respective enclave config id which is also checked during destroy operation. also destroy operation can only be done by owner.

3. Outdated enclaves can still be used
   => not fixed, outdated enclaves can still be used and can be deleted by anyone
   can not be deleted by anyone now
   
   - Fixed, outdated enclaves can not be deleted by anyone now. only enclave owner can delete the outdated enclaves.

4. If a user creates an agent and never call fund_agent, then last_funded_timestamp stays at 0. but if someone submits a request for attack, the creator can steal that reward through withdraw_from_agent
   
   - Fixed, last_funded_timestamp is set to current time during register_agent. agent creator can not withdraw funds for 14 days since registeration time.

5. Requiring a one time witness for enclave::new_cap would make it safer as it would be impossible for others to create caps (and therefore configs and enclaves) using the same type as a module
   => not fixed
   - Fixed

6. update_agent_prompt should be timelocked, otherwise a defender could exploit prompt updates to steal value from attackers.
   => The timelock implementation is ambiguous because the system_prompt can be changed without notice three hours after creation. A grace period before changes take effect seems necessary, and the time window should be based on the latest modification time rather than the creation time
   

Suggestions

1. AgentCap can be used instead of Config.admin
   => AgentCap is unused

   - Using agent cap now instead of agent.creator. this is a good pattern as it will allow people to transfer/sell agents but I had to add `claim_fees` method to allow current owner to claim entire fees.

2. Setter function that emit events such as sentinel::update_protocol_wallet could check if the new value is different from old one for avoiding emitting unnecessary events
   - Fixed.

3. We think enclave::deploy_old_enclave_by_owner was supposed to be called destroy_old_enclave_by_owner. Also, this function destroys the enclave without checking its version, so maybe it should be called destroy_enclave_by_owner
   => not fixed

   - Fixed. now there is only one function to destroy old enclaves, that too can be only done by owner.

4. The Attack.used field does not appear to be necessary
 - Fixed

Additional questions

1. Should update_agent_cost also be subject to a timelock and bounded by cost limits? Without an upper bound, once sufficient rewards have accumulated, the cost per message could be increased to a level that prevents any further calls
update_agent_cost is also timelocked now similar to update_agent_prompt.

Yes, added similar 3 hour timelock for update_agent_cost as well.


2. In the attack flow, queries are sent to the TEE using an Attack object, right? However, after observing the result, is it possible to skip calling consume_prompt? If so, would this allow the same unconsumed Attack object to be reused for additional queries?

# Feedback date: Dec 24, 2025

Hey, we’ve reviewed the patch and here’s our feedback. We also list the remaining unresolved items and would love to get your thoughts

Issues

1. In consume_prompt, the relationship between the Agent and the Enclave is not verified, so an attacker could use a signature generated by a fake Enclave to win
   => when an enclave is updated, if multiple enclaves exist, it is not defined which enclave will be used for execution

2. Since multiple enclave's config can be created by a module, its possible to create an enclave using one, and then use a different config to destroy it (if the later has a bigger version).
   => not fixed

3. Outdated enclaves can still be used
   => not fixed, outdated enclaves can still be used and can be deleted by anyone

4. Requiring a one time witness for enclave::new_cap would make it safer as it would be impossible for others to create caps (and therefore configs and enclaves) using the same type as a module
   => not fixed

Suggestions

1. AgentCap can be used instead of Config.admin
   => AgentCap is unused

2. We think enclave::deploy_old_enclave_by_owner was supposed to be called destroy_old_enclave_by_owner. Also, this function destroys the enclave without checking its version, so maybe it should be called destroy_enclave_by_owner
   => not fixed

3. The Attack.used field does not appear to be necessary
